# aea-hashicorp v2
![BuildByPerseoTeam](https://img.shields.io/badge/Built%20By-Perseo%20Team-yellow?style=for-the-badge&logo=data%3Aimage%2Fsvg%2Bxml%3Bbase64,PHN2ZyByb2xlPSJpbWciIHZpZXdCb3g9IjAgMCAyNCAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48dGl0bGU+Tm9kZS5qczwvdGl0bGU+PHBhdGggZD0iTTExLjk5OCwyNGMtMC4zMjEsMC0wLjY0MS0wLjA4NC0wLjkyMi0wLjI0N2wtMi45MzYtMS43MzdjLTAuNDM4LTAuMjQ1LTAuMjI0LTAuMzMyLTAuMDgtMC4zODMgYzAuNTg1LTAuMjAzLDAuNzAzLTAuMjUsMS4zMjgtMC42MDRjMC4wNjUtMC4wMzcsMC4xNTEtMC4wMjMsMC4yMTgsMC4wMTdsMi4yNTYsMS4zMzljMC4wODIsMC4wNDUsMC4xOTcsMC4wNDUsMC4yNzIsMGw4Ljc5NS01LjA3NiBjMC4wODItMC4wNDcsMC4xMzQtMC4xNDEsMC4xMzQtMC4yMzhWNi45MjFjMC0wLjA5OS0wLjA1My0wLjE5Mi0wLjEzNy0wLjI0MmwtOC43OTEtNS4wNzJjLTAuMDgxLTAuMDQ3LTAuMTg5LTAuMDQ3LTAuMjcxLDAgTDMuMDc1LDYuNjhDMi45OSw2LjcyOSwyLjkzNiw2LjgyNSwyLjkzNiw2LjkyMXYxMC4xNWMwLDAuMDk3LDAuMDU0LDAuMTg5LDAuMTM5LDAuMjM1bDIuNDA5LDEuMzkyIGMxLjMwNywwLjY1NCwyLjEwOC0wLjExNiwyLjEwOC0wLjg5VjcuNzg3YzAtMC4xNDIsMC4xMTQtMC4yNTMsMC4yNTYtMC4yNTNoMS4xMTVjMC4xMzksMCwwLjI1NSwwLjExMiwwLjI1NSwwLjI1M3YxMC4wMjEgYzAsMS43NDUtMC45NSwyLjc0NS0yLjYwNCwyLjc0NWMtMC41MDgsMC0wLjkwOSwwLTIuMDI2LTAuNTUxTDIuMjgsMTguNjc1Yy0wLjU3LTAuMzI5LTAuOTIyLTAuOTQ1LTAuOTIyLTEuNjA0VjYuOTIxIGMwLTAuNjU5LDAuMzUzLTEuMjc1LDAuOTIyLTEuNjAzbDguNzk1LTUuMDgyYzAuNTU3LTAuMzE1LDEuMjk2LTAuMzE1LDEuODQ4LDBsOC43OTQsNS4wODJjMC41NywwLjMyOSwwLjkyNCwwLjk0NCwwLjkyNCwxLjYwMyB2MTAuMTVjMCwwLjY1OS0wLjM1NCwxLjI3My0wLjkyNCwxLjYwNGwtOC43OTQsNS4wNzhDMTIuNjQzLDIzLjkxNiwxMi4zMjQsMjQsMTEuOTk4LDI0eiBNMTkuMDk5LDEzLjk5MyBjMC0xLjktMS4yODQtMi40MDYtMy45ODctMi43NjNjLTIuNzMxLTAuMzYxLTMuMDA5LTAuNTQ4LTMuMDA5LTEuMTg3YzAtMC41MjgsMC4yMzUtMS4yMzMsMi4yNTgtMS4yMzMgYzEuODA3LDAsMi40NzMsMC4zODksMi43NDcsMS42MDdjMC4wMjQsMC4xMTUsMC4xMjksMC4xOTksMC4yNDcsMC4xOTloMS4xNDFjMC4wNzEsMCwwLjEzOC0wLjAzMSwwLjE4Ni0wLjA4MSBjMC4wNDgtMC4wNTQsMC4wNzQtMC4xMjMsMC4wNjctMC4xOTZjLTAuMTc3LTIuMDk4LTEuNTcxLTMuMDc2LTQuMzg4LTMuMDc2Yy0yLjUwOCwwLTQuMDA0LDEuMDU4LTQuMDA0LDIuODMzIGMwLDEuOTI1LDEuNDg4LDIuNDU3LDMuODk1LDIuNjk1YzIuODgsMC4yODIsMy4xMDMsMC43MDMsMy4xMDMsMS4yNjljMCwwLjk4My0wLjc4OSwxLjQwMi0yLjY0MiwxLjQwMiBjLTIuMzI3LDAtMi44MzktMC41ODQtMy4wMTEtMS43NDJjLTAuMDItMC4xMjQtMC4xMjYtMC4yMTUtMC4yNTMtMC4yMTVoLTEuMTM3Yy0wLjE0MSwwLTAuMjU0LDAuMTEyLTAuMjU0LDAuMjUzIGMwLDEuNDgyLDAuODA2LDMuMjQ4LDQuNjU1LDMuMjQ4QzE3LjUwMSwxNy4wMDcsMTkuMDk5LDE1LjkxLDE5LjA5OSwxMy45OTN6Ii8+PC9zdmc+)


Libreria desarrollada en node para interactuar con los servicios de consul y vault. 

## Install


- Config nexus repository (file ".npmrc")
``` bas
registry=https://nexus.aireuropa.com/repository/npm-central/
email=jenkinspyc@aireuropa.com
always-auth=true
```
- Es necesario crear la variable de entorno "npm_config__auth" con el token del usuario jenkinspyc
``` bash
//windows
$ set npm_config__auth=am*ua2************

//linux
$ export npm_config__auth=am*ua2************
```

- Install
``` bash
$ npm i aea-hashicorp
```

## consul.init
* Carga en un objeto las KV (consul) obtenidas en la URL: CONSUL_URL + '/v1/kv/' + NOMAD_DC + '/' + NOMAD_JOB_NAME + '.yml'
* Las KV deben estar en yml  
* Si existe la variable de entorno `CONSUL_HTTP_TOKEN` se usará para Activar el Soporte de ACLs
* Inicia cron para:
    * Refrescar los servicios: Cada 15 segundos refresca las instancias (ip:port) de las servicios indicados.   
    * Refrescar KV: Cada 5 minutos refresca las kv. 
* los certificados se cargan de los path obtenidos en las siguientes variables de entornos:
    * ca: CONSUL_CA
    * cert: CONSUL_CLI
    * key: CONSUL_KEY
* @param  {object} [objectData] - json de configuración donde guardar las KV de consul
* @param  {object} [config]- json de configuración. Ejemplo: {discovery: {kermit: 'sec-hydra-rest',loyalty: 'suma-loyalty-rest--v4'},kv: true}

## consul.getAllocation
Retorna la dirección de la instancia del servicio indicado
* @param {string} service - nombre del servicio a devolver

## vault.init
* Carga en variables de entorno los secretos (vault) obtenidos en la URL: VAULT_URL + '/v1/secret/' + NOMAD_DC + '/' + NOMAD_JOB_NAME + '.json'
* Recupera el valor del header X-Vault-Token de la variable de entorno VAULT_TOKEN. nomad lo inyecta automáticamente  
* Los secretos deben estar en formato  json
* los certificados se cargan de los path obtenidos en las siguientes variables de entornos:  
    * ca: process.env.VAULT_CA
    * cert: process.env.VAULT_CLI
    * key: process.env.VAULT_KEY
    
## Usage
``` js
const hashicorp  = require('aea-hashicorp');

// configuracion necesaria para el funcionamiento de consul
let conf = {
    consul: {
        discovery: {
            kermit: 'sec-hydra-rest',
            loyalty: 'suma-loyalty-rest--v4'
        },
        kv: true
    }
};

//Inicializa consul
await hashicorp.consul.init(conf,conf.consul);

//Obtener la allocation
let allocation = await hashicorp.consul.getAllocation(conf.consul.discovery.loyalty);

//Inicializa vault
await hashicorp.vault.init();

```

# Testing

Se han generado certificado autofirmados para los tests con un tiempo de vida de 730 días si necesitan ser regenerados, el script está en la carpeta `./test/ssl` y se llama `create_ssl_certs.sh`.


![build with love](https://forthebadge.com/images/badges/built-with-love.svg)

&copy; Air Europa SA. Todos los derechos reservados.  