"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.fastifyAeaLogger = void 0;
const aea_logger_1 = require("aea-logger");
const fastify_plugin_1 = require("fastify-plugin");
const symbolNow = Symbol("RequestTimer");
const log = (fastify, opts, done) => {
    const exclude = (typeof opts.exclude === 'string') ? [opts.exclude] : opts.exclude || [];
    fastify.addHook('onRequest', async (req) => {
        req.raw[symbolNow] = Date.now();
    });
    fastify.addHook('onSend', async (req, res) => {
        const route = req.routeOptions.url?.valueOf() || "";
        if (exclude.includes(route)) {
            return done();
        }
        const ipAddr = req.headers['true-client-ip'] || req.socket.remoteAddress;
        aea_logger_1.logger.info(ipAddr + ' - "' + req.method + ' ' + req.url + '" ' + res.statusCode + " " + (Date.now() - req.raw[symbolNow]) + 'ms');
    });
    done();
};
exports.fastifyAeaLogger = (0, fastify_plugin_1.default)(log, {
    fastify: '5.x',
    name: 'fastify-aea-logger'
});
