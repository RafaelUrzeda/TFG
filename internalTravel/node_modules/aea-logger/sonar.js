const fs = require("fs");
const scanner = require("sonarqube-scanner").default;

const dir = fs.readdirSync("./src");
let sources = "";

const pkj = JSON.parse(fs.readFileSync("package.json", { encoding: "utf-8" }));

for (const i in dir) {
  if (dir[i] != "server.ts") {
    if (sources !== "") {
      sources = sources + ", ";
    }
    sources = sources + "src/" + dir[i];
  }
}

let options = {
  "sonar.projectName": pkj.name,
  "sonar.projectDescription": pkj.description,
  "sonar.projectVersion": pkj.version,
  "sonar.sources": sources,
  "sonar.tests": "test",
  "sonar.eslint.reportPaths": "lint-report.json",
  "sonar.javascript.lcov.reportPaths": "coverage/lcov.info",
  "sonar.coverage.jacoco.xmlReportPaths": "coverage/sonar-report.xml",
  "sonar.testExecutionReportPaths": "coverage/sonar-report.xml",
  "sonar.qualitygate.wait": "true",
  "sonar.log.level": "INFO",
  "sonar.verbose": "false",
};

scanner(
  {
    serverUrl:
      process.env["SONAR_URL"] ||
      "https://sonar.devops.private.aws.aireuropa.com/",
    token: process.env["SONAR_TOKEN"],
    options: options,
  },
  () => process.exit(),
);
